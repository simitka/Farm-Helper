#!/bin/zsh

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã farmx
function finalize() {
    echo
    echo "–ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –Ω–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–Ω–æ–ø–∫—É..."
    stty -icanon
    dd bs=1 count=1 >/dev/null 2>&1
    stty icanon
    farmx
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
if [ "$#" -eq 0 ]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–µ—Ä–µ–¥–∞–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ ADB (—Å–æ–æ–±—â–∏—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É —Å–∫—Ä–∏–ø—Ç–∞)"
    finalize
    exit 1
fi

# –ü–µ—Ä–µ–±–∏—Ä–∞–µ–º –≤—Å–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã
index=0
for device in "$@"; do
    # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç —Å –∏–Ω–¥–µ–∫—Å–æ–º 0 (—Ç–∞–º $settings_file)
    if ((index > 0)); then

        # –°–ø—Ä–∞—à–∏–≤–∞–µ–º –ø—É—Ç—å –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ñ–∞–π–ª–∞ (—Ç–æ–ª—å–∫–æ –ø–∞–ø–∫—É)
        echo "–í–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ª–æ–≥–æ–≤ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ $device:"
        echo "(–∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ Enter‚Üµ —á—Ç–æ–±—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ø–∞–ø–∫—É ~/Downloads)"
        read -r user_dir

        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∏—á–µ–≥–æ –Ω–µ –≤–≤–µ–ª
        if [[ -z "$user_dir" ]]; then
            user_dir=~/Downloads
            echo "üìÇ–ò—Å–ø–æ–ª—å–∑—É—é –ø—É—Ç—å –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é: $user_dir"
        else
            echo "üìÇ–ò—Å–ø–æ–ª—å–∑—É—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–π –ø—É—Ç—å: $user_dir"
        fi

        # –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –ø—É—Ç—å —Å ~ –≤ –ø–æ–ª–Ω—ã–π –ø—É—Ç—å
        user_dir=$(eval echo "$user_dir")

        # –°–æ–∑–¥–∞–µ–º –ø–∞–ø–∫—É, –µ—Å–ª–∏ –æ–Ω–∞ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
        mkdir -p "$user_dir" && echo "üìÇ –ü–∞–ø–∫–∞ $user_dir —Å–æ–∑–¥–∞–Ω–∞ –∏–ª–∏ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."

        # –§–æ—Ä–º–∏—Ä—É–µ–º –ø–æ–ª–Ω—ã–π –ø—É—Ç—å –∫ —Ñ–∞–π–ª—É —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –∏–º–µ–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        file_name="logs_$(basename "$device").txt"
        user_path="${user_dir%/}/$file_name" # –£–±–∏—Ä–∞–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–π —Å–ª–µ—à –≤ –∫–æ–Ω—Ü–µ –ø—É—Ç–∏

        # –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –¥–∞–º–ø–∞ –ª–æ–≥–æ–≤
        echo "‚è≥ –°–∫–∞—á–∏–≤–∞—é –ª–æ–≥–∏ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ $device..."
        # –ó–∞–ø—É—Å–∫–∞–µ–º adb logcat –∏ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤ —Ñ–∞–π–ª
        adb -s "$device" logcat -d >"${user_path}" && echo "‚úÖ –õ–æ–≥–∏ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: ${user_path}" || echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å —Å–∫–∞—á–∞—Ç—å –ª–æ–≥–∏"
        echo

    fi
    ((index++))
done

finalize
exit 0
