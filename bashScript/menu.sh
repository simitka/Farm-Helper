#!/bin/zsh

# –í—ã–¥–∞–µ–º –≤—Å–µ–º .sh —Ñ–∞–π–ª–∞–º –≤ –ø–∞–ø–∫–µ –ø—Ä–∞–≤–∞ –Ω–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ
find . -type f -name "*.sh" -exec chmod +x {} \;

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∞—Ä–≥—É–º–µ–Ω—Ç–∞
if [[ $# -ne 2 ]]; then
  echo "‚ùå –û—à–∏–±–∫–∞: –í–æ –≤—Ä–µ–º—è –≤—ã–∑–æ–≤–∞ —Å–∫—Ä–∏–ø—Ç–∞ –ø–µ—Ä–µ–¥–∞–Ω—ã –Ω–µ –≤—Å–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∞—Ä–≥—É–º–µ–Ω—Ç—ã (—Å–æ–æ–±—â–∏—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É —Å–∫—Ä–∏–ø—Ç–∞)"
  exit 1
fi

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–∞
settings_file="$1"
actual_tag_version="$2"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º
bold_text() {
  local text="$1"
  echo "\033[1m$text\033[0m"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã farmx
function finalize() {
  echo
  echo "–ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –Ω–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–Ω–æ–ø–∫—É..."
  stty -icanon
  dd bs=1 count=1 >/dev/null 2>&1
  stty icanon
  farmx
}

function choose_adb() {
  local script_name="$1"

  # –û—á–∏—â–∞–µ–º –∫–æ–Ω—Å–æ–ª—å
  clear

  # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤, –∏—Å–∫–ª—é—á–∞—è –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ —Å—Ç—Ä–æ–∫–∏ "unauthorized", "offline" –∏ —Ç.–¥.
  devices=($(adb devices | awk 'NR>1 && $2=="device" {print $1}'))
  device_count=${#devices[@]}

  if [[ $device_count -eq 0 ]]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∫ ADB —É—Å—Ç—Ä–æ–π—Å—Ç–≤."
    finalize
    exit 1
  fi

  # –ï—Å–ª–∏ –æ–¥–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
  if [[ $device_count -eq 1 ]]; then
    device=${devices[1]}
    eval $script_name "$settings_file" "$device"
    exit 0
  fi

  # –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
  echo "-------------------------------"
  echo "–ö adb –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤"
  echo "-------------------------------"
  echo "    [0] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –¥–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ"

  for ((i = 0; i < device_count; i++)); do
    echo "    [$((i + 1))] ${devices[i + 1]}"
  done

  echo -n "üìù –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ: "
  read device_choice
  echo

  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –≤–≤–æ–¥–∞
  if ! [[ $device_choice =~ ^[0-9]+$ ]] || [[ $device_choice -lt 0 ]] || [[ $device_choice -gt $device_count ]]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã–±–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
    finalize
    exit 1
  fi

  if [[ $device_choice -eq 0 ]]; then
    # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –¥–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    for device in "${devices[@]}"; do
      eval $script_name "$settings_file" "$devices"
    done
  else
    # –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    selected_device=${devices[$((device_choice))]}
    eval $script_name "$settings_file" "$selected_device"
  fi

  finalize
  exit 0
}

#
#
#

# –û—á–∏—â–∞–µ–º –∫–æ–Ω—Å–æ–ª—å
clear

# –í—ã–≤–æ–¥–∏–º –º–µ–Ω—é –≤—ã–±–æ—Ä–∞
while true; do
  bold_text "Farm Helper v$actual_tag_version"

  echo "–ß—Ç–æ–±—ã –∑–∞–∫—Ä—ã—Ç—å —Å–∫—Ä–∏–ø—Ç –Ω–∞–∂–º–∏—Ç–µ Control‚åÉ + C"
  echo "–ß—Ç–æ–±—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫—Ä–∏–ø—Ç –≤–≤–µ–¥–∏—Ç–µ 'farmx' –≤ –¢–µ—Ä–º–∏–Ω–∞–ª–µ"
  echo
  bold_text "–í—ã–±–µ—Ä–∏—Ç–µ –Ω—É–∂–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –∏ –≤–≤–µ–¥–∏—Ç–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â—É—é —Ü–∏—Ñ—Ä—É:"
  echo "    [1] –ü–æ—á–∏—Å—Ç–∏—Ç—å –∫—ç—à –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
  echo "    [2] –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
  echo "    [3] –£–¥–∞–ª–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
  echo "    [4] –ü–µ—Ä–µ—Ö–æ–¥ –ø–æ DeepLink"
  echo "    [5] –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è —Å –ø–æ–º–æ—â—å—é DeepLink (FAR-4168)"
  echo "    [6] –ß—Ç–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∞–π–ª–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω–æ–≥–æ –ø–æ ADB —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
  echo "    [7] –£–¥–∞–ª–∏—Ç—å –∫—ç—à –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –≤ Unity Editor"
  echo "    [8] –°–∫–∞—á–∞—Ç—å –¥–∞–º–ø logcat –ª–æ–≥–æ–≤ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
  echo "    [9] (todo) –ü–æ—á–∏—Å—Ç–∏—Ç—å logcat –ª–æ–≥–∏ –∏ –Ω–∞—á–∞—Ç—å –∑–∞–ø–∏—Å—å –≤ —Ñ–∞–π–ª"

  # –û–∂–∏–¥–∞–Ω–∏–µ –≤–≤–æ–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  echo -n "üìù –í–≤–µ–¥–∏—Ç–µ —Ü–∏—Ñ—Ä—É: "
  read choice

  # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–≤–æ–¥ —á–∏—Å–ª–æ–º –∏ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –æ–Ω –≤ –¥–æ–ø—É—Å—Ç–∏–º–æ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
  if [[ "$choice" =~ ^[1-9]$ ]]; then
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    case "$choice" in
    1)
      choose_adb "./bashScript/clearCache.sh"
      ;;
    2)
      choose_adb "./bashScript/installApp.sh"
      ;;
    3)
      choose_adb "./bashScript/uninstallApp.sh"
      ;;
    4)
      choose_adb "./bashScript/openDeeplink.sh"
      ;;
    5)
      echo "‚è≥ –ó–∞–ø—É—Å–∫–∞—é —Å–∫—Ä–∏–ø—Ç changeLevel.sh..."
      #./changeLevel.sh
      dotnet script dotnetScript/changeLevelDeeplink.csx --no-cache

      ;;
    6)
      clear
      ./bashScript/chooseProfile.sh
      ;;
    7)
      ./bashScript/deleteUnityCache.sh
      ;;
    8)
      choose_adb "./bashScript/logcatDump.sh"
      ;;
    9)
      clear
      echo "‚è≥ –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –ø–æ–∫–∞ —á—Ç–æ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ:)"
      finalize
      ;;
    esac
    break # –í—ã—Ö–æ–¥ –∏–∑ —Ü–∏–∫–ª–∞ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞
  else
    # –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–≤–µ—Ä–Ω–æ–≥–æ –≤–≤–æ–¥–∞
    clear
    bold_text "‚ùå –û—à–∏–±–∫–∞: –í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –æ—Ç 1 –¥–æ 9 –∏ –Ω–∞–∂–º–∏—Ç–µ Enter"
    echo "============================================================"
    echo
    echo
  fi
done
