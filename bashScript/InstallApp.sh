#!/bin/zsh

# –ü–æ–¥—Å–∫–ª—é—á–∞–µ–º utils.sh
source ./bashScript/utils.sh

# –í–∫–ª—é—á–∞–µ–º –æ–ø—Ü–∏—é nullglob –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ $target_dir
setopt nullglob

# –§—É–Ω–∫—Ü–∏—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ adb –¥–ª—è –º–∞—Å—Å–∏–≤–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
function adbAppInstall() {
    for device in "$@"; do
        # –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–≤—ã–π –∞—Ä–≥—É–º–µ–Ω—Ç —Å –∏–Ω–¥–µ–∫—Å–æ–º 0 (—Ç–∞–º $settings_file)
        if ((index > 0)); then
            echo "‚è≥ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é $install_file –¥–ª—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ $device..."
            adb -s "$device" install "$install_file"
        fi
        ((index++))
    done

    echo "‚úÖ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    finalize
    exit 0
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø–µ—Ä–µ–¥–∞–Ω–Ω—ã—Ö –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –≤ –º–æ–º–µ–Ω—Ç –≤—ã–∑–æ–≤–∞ —Å–∫—Ä–∏–ø—Ç–∞
if [[ $# -lt 2 ]]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –≤ –∞—Ä–≥—É–º–µ–Ω—Ç–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –ø–µ—Ä–µ–¥–∞–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ ADB (—Å–æ–æ–±—â–∏—Ç–µ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫—É —Å–∫—Ä–∏–ø—Ç–∞)"
    exit 1
fi

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø—É—Ç–∏ –∫ —Ñ–∞–π–ª—É –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏–∑ –∞—Ä–≥—É–º–µ–Ω—Ç–∞
settings_file="$1"

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è actualPath –∏–∑ —Ñ–∞–π–ª–∞ –Ω–∞—Å—Ç—Ä–æ–µ–∫
actual_path=$(grep '^actualPath:' "$settings_file" | cut -d':' -f2 | xargs)

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —á—Ç–æ actual_path –Ω–µ –ø—É—Å—Ç–æ–π
if [[ -z $actual_path ]]; then
    echo "‚ùå –û—à–∏–±–∫–∞: –ó–Ω–∞—á–µ–Ω–∏–µ actualPath –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ $settings_file"
    exit 1
fi

# –û—á–∏—â–∞–µ–º –∫–æ–Ω—Å–æ–ª—å
clear

# –ü–µ—Ä–µ—Ö–æ–¥ –≤ –∫–∞—Ç–∞–ª–æ–≥ actual_path/farmBuilds
target_dir="$actual_path/farmBuilds"
if [[ ! -d $target_dir ]]; then
    mkdir -p "$target_dir"
fi
cd "$target_dir"

# –°–∫–∞—á–∏–≤–∞–Ω–∏–µ
echo "‚è≥ –°–∫–∞—á–∏–≤–∞—é .apk —Ñ–∞–π–ª—ã –∏–∑ git lfs..."
git lfs pull
clear

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .apk –∏ .apks
file_list=(*.apk *.apks)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –∏ –≤—ã–≤–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ [1] —Ñ–∞–π–ª1
if [[ ${#file_list[@]} -eq 0 ]]; then
    echo "‚ùå –í –ø–∞–ø–∫–µ $target_dir –Ω–µ—Ç —Ñ–∞–π–ª–æ–≤ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ–º .apk –∏–ª–∏ .apks"
    echo -n "–î–æ–±–∞–≤—å—Ç–µ .apk —Ñ–∞–π–ª—ã –≤ —É–∫–∞–∑–∞–Ω–Ω—É—é –≤—ã—à–µ –ø–∞–ø–∫—É, –∏–ª–∏ "
else
    echo "-------------------------------"
    echo "–°–ø–∏—Å–æ–∫ .apk —Ñ–∞–π–ª–æ–≤ –≤ –ø–∞–ø–∫–µ $target_dir:"
    echo "-------------------------------"
    for i in {1..${#file_list[@]}}; do
        echo "  [$i] ${file_list[$i]}" # –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –º–∞—Å—Å–∏–≤–∞
    done
    echo "üìù –í–≤–µ–¥–∏—Ç–µ —Ü–∏—Ñ—Ä—É, —É–∫–∞–∑–∞–Ω–Ω—É—é –Ω–∞–ø—Ä–æ—Ç–∏–≤ –±–∏–ª–¥–∞ –∫–æ—Ç–æ—Ä—ã–π –≤—ã —Ö–æ—Ç–∏—Ç–µ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å."
    echo -n "–ò–ª–∏ "
fi

# –ó–∞–ø—Ä–æ—Å –≤–≤–æ–¥–∞ –Ω–æ–º–µ—Ä–∞ –±–∏–ª–¥–∞ –∏–ª–∏ –ø—É—Ç–∏ –∫ .apk —Ñ–∞–π–ª—É
echo -n "–≤–≤–µ–¥–∏—Ç–µ –ø—É—Ç—å –∫ .apk —Ñ–∞–π–ª—É: "
read user_input
echo

# –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –≤–≤–æ–¥ —á–∏—Å–ª–æ–º –∏ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö –¥–æ–ø—É—Å—Ç–∏–º–æ–≥–æ –¥–∏–∞–ø–∞–∑–æ–Ω–∞
if [[ "$user_input" =~ ^[0-9]+$ ]] && [[ $user_input -ge 1 && $user_input -le ${#file_list[@]} ]]; then
    # –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    install_file=${file_list[$((user_input))]}
    adbAppInstall "$@"
elif [[ -n $user_input ]]; then
    # –£–¥–∞–ª–µ–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω—ã—Ö –∫–∞–≤—ã—á–µ–∫ –∏–∑ –Ω–∞—á–∞–ª–∞ –∏ –∫–æ–Ω—Ü–∞ —Å—Ç—Ä–æ–∫–∏
    user_input=${user_input#\"} # –£–¥–∞–ª–∏—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
    user_input=${user_input#\'} # –£–¥–∞–ª–∏—Ç—å –Ω–∞—á–∞–ª—å–Ω—ã–µ –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
    user_input=${user_input%\"} # –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω–µ—á–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏
    user_input=${user_input%\'} # –£–¥–∞–ª–∏—Ç—å –∫–æ–Ω–µ—á–Ω—ã–µ –æ–¥–∏–Ω–∞—Ä–Ω—ã–µ –∫–∞–≤—ã—á–∫–∏

    # –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —É–∫–∞–∑–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥—ã —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    if [[ -f $user_input ]]; then
        install_file=$user_input
        adbAppInstall "$@"
    else
        echo "‚ùå –û—à–∏–±–∫–∞: –£–∫–∞–∑–∞–Ω–Ω—ã–π —Ñ–∞–π–ª –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç $user_input"
        exit 1
    fi
else
    echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ–≤–µ—Ä–Ω—ã–π –≤–≤–æ–¥. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –≤–≤–µ–ª–∏ –Ω–æ–º–µ—Ä –∏–∑ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø—É—Ç—å –∫ .apk —Ñ–∞–π–ª—É"
    exit 1
fi
