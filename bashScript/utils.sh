#!/bin/zsh

#–î–ª—è –ø—Ä–∏–º–µ—Ä–∞ –≤—ã—Ö–æ–≤–∞ —Ñ—É–Ω–∫—Ü–∏–∏ –≤ —Ñ—É–Ω–∫—Ü–∏–∏ ‚Äì bold_text "$(red_text '–ö—Ä–∞—Å–Ω—ã–π –∂–∏—Ä–Ω—ã–π —Ç–µ–∫—Å—Ç')"

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –∂–∏—Ä–Ω—ã–º
bold_text() {
    echo "$(tput bold)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç—É—Å–∫–ª–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
dim_text() {
    echo "$(tput dim)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ –ø–æ–¥—á–µ—Ä–∫–Ω—É—Ç–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
underline_text() {
    echo "$(tput smul)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–Ω–≤–µ—Ä—Å–∏–∏ —Ü–≤–µ—Ç–æ–≤ (—Ñ–æ–Ω ‚Üî —Ç–µ–∫—Å—Ç)
reverse_text() {
    echo "$(tput rev)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –º–∏–≥–∞—é—â–µ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–Ω–µ –≤—Å–µ–≥–¥–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç)
blink_text() {
    echo "$(tput blink)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–µ–≤–∏–¥–∏–º–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ (–µ–≥–æ –º–æ–∂–Ω–æ —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –∏ –≤—Å—Ç–∞–≤–∏—Ç—å)
invisible_text() {
    echo "$(tput invis)$1$(tput sgr0)"
}

#
#
#

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –∫—Ä–∞—Å–Ω—ã–º —Ü–≤–µ—Ç–æ–º
red_text() {
    echo "$(tput setaf 1)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –∑–µ–ª–µ–Ω—ã–º —Ü–≤–µ—Ç–æ–º
green_text() {
    echo "$(tput setaf 2)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –∂–µ–ª—Ç—ã–º —Ü–≤–µ—Ç–æ–º
yellow_text() {
    echo "$(tput setaf 3)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ —Å–∏–Ω–∏–º —Ü–≤–µ—Ç–æ–º
blue_text() {
    echo "$(tput setaf 4)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –ø—É—Ä–ø—É—Ä–Ω—ã–º (—Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–º) —Ü–≤–µ—Ç–æ–º
magenta_text() {
    echo "$(tput setaf 5)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –±–∏—Ä—é–∑–æ–≤—ã–º (—Ü–∏–∞–Ω–æ–≤—ã–º) —Ü–≤–µ—Ç–æ–º
cyan_text() {
    echo "$(tput setaf 6)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ –±–µ–ª—ã–º —Ü–≤–µ—Ç–æ–º
white_text() {
    echo "$(tput setaf 7)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ —á–µ—Ä–Ω—ã–º —Ü–≤–µ—Ç–æ–º (–º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–≤–∏–¥–∏–º—ã–º –≤ —Ç–µ–º–Ω—ã—Ö —Ç–µ–º–∞—Ö)
black_text() {
    echo "$(tput setaf 0)$1$(tput sgr0)"
}

#
#
#

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —á—ë—Ä–Ω–æ–≥–æ —Ñ–æ–Ω–∞
black_bg() {
    echo "$(tput setab 0)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∫—Ä–∞—Å–Ω–æ–≥–æ —Ñ–æ–Ω–∞
red_bg() {
    echo "$(tput setab 1)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–µ–ª—ë–Ω–æ–≥–æ —Ñ–æ–Ω–∞
green_bg() {
    echo "$(tput setab 2)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∂—ë–ª—Ç–æ–≥–æ —Ñ–æ–Ω–∞
yellow_bg() {
    echo "$(tput setab 3)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–∏–Ω–µ–≥–æ —Ñ–æ–Ω–∞
blue_bg() {
    echo "$(tput setab 4)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—É—Ä–ø—É—Ä–Ω–æ–≥–æ (—Ñ–∏–æ–ª–µ—Ç–æ–≤–æ–≥–æ) —Ñ–æ–Ω–∞
magenta_bg() {
    echo "$(tput setab 5)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–æ–ª—É–±–æ–≥–æ (—Ü–∏–∞–Ω–æ–≤–æ–≥–æ) —Ñ–æ–Ω–∞
cyan_bg() {
    echo "$(tput setab 6)$1$(tput sgr0)"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–ª–æ–≥–æ —Ñ–æ–Ω–∞
white_bg() {
    echo "$(tput setab 7)$1$(tput sgr0)"
}

#
#
#

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥—ã farmx
function finalize() {
    echo
    echo "–ß—Ç–æ–±—ã –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å, –Ω–∞–∂–º–∏—Ç–µ –ª—é–±—É—é –∫–Ω–æ–ø–∫—É..."
    stty -icanon
    dd bs=1 count=1 >/dev/null 2>&1
    stty icanon
    farmx
}

function choose_adb() {
    local script_name="$1"

    # –û—á–∏—â–∞–µ–º –∫–æ–Ω—Å–æ–ª—å
    clear

    # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤, –∏—Å–∫–ª—é—á–∞—è –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –∏ —Å—Ç—Ä–æ–∫–∏ "unauthorized", "offline" –∏ —Ç.–¥.
    devices=($(adb devices | awk 'NR>1 && $2=="device" {print $1}'))
    device_count=${#devices[@]}

    if [[ $device_count -eq 0 ]]; then
        echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –∫ ADB —É—Å—Ç—Ä–æ–π—Å—Ç–≤."
        finalize
        exit 1
    fi

    # –ï—Å–ª–∏ –æ–¥–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
    if [[ $device_count -eq 1 ]]; then
        device=${devices[1]}
        eval $script_name "$settings_file" "$device"
        exit 0
    fi

    # –ï—Å–ª–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
    echo "-------------------------------"
    echo "–ö adb –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤"
    echo "-------------------------------"
    echo "    [0] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –¥–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∏–∂–µ"

    for ((i = 0; i < device_count; i++)); do
        echo "    [$((i + 1))] ${devices[i + 1]}"
    done

    echo -n "üìù –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –≤—ã—à–µ: "
    read device_choice
    echo

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –≤–≤–æ–¥–∞
    if ! [[ $device_choice =~ ^[0-9]+$ ]] || [[ $device_choice -lt 0 ]] || [[ $device_choice -gt $device_count ]]; then
        echo "‚ùå –û—à–∏–±–∫–∞: –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã–±–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞"
        finalize
        exit 1
    fi

    if [[ $device_choice -eq 0 ]]; then
        # –û—á–∏—Å—Ç–∫–∞ –∫—ç—à–∞ –¥–ª—è –≤—Å–µ—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        for device in "${devices[@]}"; do
            eval $script_name "$settings_file" "$devices"
        done
    else
        # –ü–æ–ª—É—á–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
        selected_device=${devices[$((device_choice))]}
        eval $script_name "$settings_file" "$selected_device"
    fi

    finalize
    exit 0
}
